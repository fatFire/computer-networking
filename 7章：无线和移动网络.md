**目录：**

- [7. 无线和移动网络](#7-无线和移动网络)
  - [7.1. 介绍](#71-介绍)
  - [7.2. 无线链路和网络特征](#72-无线链路和网络特征)
    - [7.2.1. 码分多址(CDMA)](#721-码分多址cdma)
  - [7.3. 无线局域网](#73-无线局域网)
    - [7.3.1. 802.11 架构](#731-80211-架构)
    - [7.3.2. 802.11 MAC 协议](#732-80211-mac-协议)
    - [7.3.3. IEEE 802.11 帧](#733-ieee-80211-帧)
    - [7.3.4. 在相同的 IP 子网中的移动性](#734-在相同的-ip-子网中的移动性)
    - [7.3.5. 802.11 中的高级特色](#735-80211-中的高级特色)
    - [7.3.6. 个人域网络：蓝牙](#736-个人域网络蓝牙)

# 7. 无线和移动网络

在电话通讯的世界，过去的 25 年是蜂窝电话通讯的黄金时代。在世界范围上，使用移动蜂窝网络的用户从 1993 的 240 万增加到 2019 年的 83 亿。这个数字甚至超过了世界总人口数（2019 年为 76.74 亿）。移动电话的优势是显而易见的：任何地点，任何时间，不受约束地通过一个高度轻便的设备接入全球电话网。近来，智能手机，平板电脑，和笔记本已经通过蜂窝网络或 WiFi 网络无线地接入 Internet。并且，类似于游戏手柄，温度控制器，家庭安保系统，家用智能电器，智能手表，智能眼睛，汽车，交通控制系统等正逐渐无线接入 Internet。

从计算机网络的观点来看，这些无线和移动设备引发的挑战，特别是在数据链路层和网络层，与传统的有线网络的差别非常大，适合用单独一章（即本章）的篇幅来专门讨论无线网络和移动网络。

我们这章将以讨论移动用户，无线链路及网络和他们所连接的更大的有线网络之间的关系开始。我们将明确区分无线网络的无线性和移动性。分清这两个特性将有助于我们隔离，识别，和掌握在这两个区域的关键概念。

我们将以对无线基础设施和相关术语的概览开始。之后，我们将考虑 7-2 节中无线链路的特征。我们在这一节涉及一个简短的对 **码分多址接入技术(Code Division Multiple Access, CDMA)** 的介绍，这是一种常被用于无线网络的共享媒体的接入技术。在 7-3 节，我们深度学习 IEEE 802.11(WiFi) 无线局域网标准的链路层的一些方面。同时我们还将对蓝牙和其他无线个人域网络做简要描述。在 7-4 节，我们提供一个对蜂窝网络接入，包扩 4G 和兴起的 5G 蜂窝网络技术的一个概览，5G 蜂窝网络技术同时提供语音和高速的 Internet 接入。在 7-5 节，我们将注意力转向移动性，关注于移动用户的定位问题、对移动用户的路由选择以及“切换”（handing over）移动用户（即在网络中从一个接入点动态地移动到另一点的用户）等问题。在 7-6 节和 7-7 节中，我们将分别考察如何在企业 802.11 网络和 LTE 蜂窝网络中用移动 IP 标准实现这些移动服务。最后，我们将在 7-8 节中考虑无线链路和移动性对运输层协议和网络应用程序的影响。

## 7.1. 介绍

图 7-1 显示了我们将要讨论无线数据通信和移动性主题的环境。为使讨论具有一般性以覆盖各种各样的网络，将包括像 IEEE 802.11 这样的无线局域网和像 4G，5G 网络这样的蜂窝网络来开始我们的讨论；然后在后续各节中，我们将对特定的无线体系结构进行更加详细的讨论。我们能够看到无线网络的下列要素：

- 无线主机。如同在有线网络中一样，主机是运行应用程序的端系统设备。**无线主机(wireless host)** 可以是智能手机，平板电脑，或笔记本，或者它可能是类似于传感器，智能家电，自动驾驶汽车，或者其他接入互联网的混合设备。 主机本身可能移动，也可能不移动。
- 无线链路。主机通过 **无线通信链路(wireless communication link)** 连接到一个基站（定义见下文）或者另一台无线主机。不同的无线链路技术具有不同的传输速率和能够传输不同的距离。图 7-2 显示了较为流行的无线链路标准的两种主要特性（覆盖区域和链路速率）。（该图仅表示了提供这些特性的大致概念。例如，这些类型中的某些网络现在只是在部署，某些链路速率取决于距离、信道条件和在无线网络中的用户数量，能够比显 示的值更高或更低些。）我们将在本章的前半部分讨论这些标准。在 7-2 节中，我们也考虑其他无线链路特性（如它们的比特差错率及其原因）。

![7-1-无线网络的组成部分](illustrations/7-1-无线网络的组成部分.png)

![7-2-无线传输速率和频段](illustrations/7-2-无线传输速率和频段.png)

在图 7-1 中，无线链路将位于网络边缘的主机连接到更大的网络基础设施中。我们要马上补充的是，无线链路有时同样应用在一个网络中以连接路由器、交换机和其他网络设备。然而，在本章中我们关注的焦点是无线通信在网络边缘的应用，因为许多最为振奋人心的技术挑战和多数增长就发生在这里。

- 基站。**基站(base station)** 是无线网络基础设施的一个关键部分。与无线主机和无线链路不同，基站在有线网络中没有明确的对应设备。它负责向与之关联的无线主机发送数据和从主机那里接收数据（例如分组）。基站通常负责协调与之相关联的多个无线主机的传输。当我们说一台无线主机与某基站“相关联”时，则是指：1. 该主机位于该基站的无线通信覆盖范围内；2. 该主机使用该基站中继它（该主机）和更大网络之间的数据。蜂窝网络中的 **蜂窝塔(cell tower)** 和 802.11 无线 LAN 中的 **接入点(access point)** 都是基站的例子。

在图 7-1 中，基站与更大网络相连（如因特网、公司或家庭网、电话网），因此这种连接在无线主机和与之通信的其他部分之间起着链路层中继的作用。

与基站关联的主机通常被称为以 **基础设施模式(infrastructure mode)** 运行，因为所有传统的网络服务（如地址分配和路由选择）都由网络向通过基站相连的主机提供。在 **自组织网络(ad hoc network)** 中，无线主机没有这样的基础设施与之相连。在没有这样的基础设施的情况下，主机本身必须提供诸如路由选择、地址分配、类似于 DNS 的名字转换等服务。

当一台移动主机的移动超出一个基站的覆盖范围而到达另一个基站的覆盖范围后，它将改变其接入到更大网络的连接点（即改变与之相关联的基站），这一过程称作 **切换(handoff，或 handover)**。这种移动性引发了许多具有挑战性的问题。如果一台主机可以移动，那么如何找到它在网络中的当前位置，从而使得数据可以向该移动主机转发？如果一台主机可以位于许多可能位置中的一个，那么如何进行编址？如果主机在一个 TCP 连接或者电话呼叫期间移动，数据如何路由选择而使连接保持不中断？这些以及许多（许多！）其他问题使得 无线网络和移动网络成为一个让人振奋的网络研究领域。

- 网络基础设施。这是无线主机希望与之进行通信的更大网络。

在讨论完无线网络的构件以后，我们注意到这些构件能够以多种不同方式组合以形成不同类型的无线网络。当阅读本章，或阅读/学习本书之外的更多有关无线网络的内容时, 你可能发现对这些无线网络类型进行分类的方法是有用的。在最高层次，我们能够根据两个准则来对无线网络分类：1. 在该无线网络中的分组是否跨越了一个无线跳或多个无线跳；2. 网络中是否有诸如基站这样的基础设施。

- 单跳，基于基础设施。这些网络具有与较大的有线网络（如因特网）连接的基站。此外，该基站与无线主机之间的所有通信都经过一个无线跳。你在教室、咖啡屋 或图书馆中所使用的 802.11 网络，以及我们将很快学习的 4G LTE 数据网络都属于这种类型。我们日常的绝大部分时间是在与单跳、基于基础设施的无线网络打交道。
- 单跳，无基础设施。在这些网络中，不存在与无线网络相连的基站。然而，如我们将要见到的那样，在这种单跳网络中的一个节点可以协调其他节点的传输。蓝牙网络（该网络连接诸如键盘、扬声器和戴在头上的耳机等小型无线设备，我们将在 7-3-6 节中学习）和具有自组织模式的 802.11 网络是单跳、无基础设施的网络。
- 多跳，基于基础设施。在这些网络中，一个基站表现为以有线方式与较大网络相连。然而，某种无线节点为了经该基站通信，可能不得不通过其他无线节点中继它们的通信。某些无线传感网络和所谓 **无线网状网络(wireless mesh network)** 就属于这种类型。
- 多跳，无基础设施。在这些网络中没有基站，并且节点为了到达目的地可能必须在几个其他无线节点之间中继报文。节点也可能是移动的，在多个节点中改变连接关系，一类网络被称为 **移动自组织网络(mobile ad hoc network, MANET)**。如果该移动节点是车载的，该网络是 **车载自组织网络(vehicular ad hoc network, VANET)**。如你可能想象的那样，为这种网络开发协议是一种挑战，这是许多进行中的研究主题。

在本章中，我们将把主要学习内容限制在单跳网络，并且大多数是基于基础设施的网络。

现在我们更深一步地研究无线网络和移动网络面对的挑战。我们将首先讨论单独的无线链路，而在本章稍后部分讨论移动性。

## 7.2. 无线链路和网络特征

无线链路在多个方面不同于有线链路：

- 递减的信号强度。电磁波在穿过物体（如无线电信号穿过墙壁）时强度将减弱。即使在自由空间中，信号仍将扩散，这使得信号强度随着发送方和接收方距离的增加而减弱（有时称其为 **路径损耗(path loss)** ）。
- 来自其他源的干扰。在同一个频段发送信号的电波源将相互干扰。例如，2.4GHz 无线电话和 802.11b 无线 LAN 在相同的频段中传输。因此，802.11b 无线 LAN 用户若同时利用 2.4GHz 无线电话通信，将会导致网络和电话都不会工作得特别好。除了来自发送源的干扰，环境中的电磁噪声（如附近的电动机、微波）也能形成干扰。
- 多径传播。当电磁波的一部分受物体和地面反射，在发送方和接收方之间走了不同长度的路径，则会出现 **多径传播(multipath propagation)**。这使得接收方收到的信号变得模糊。位于发送方和接收方之间的移动物体可导致多径传播随时间而改变。

对于无线信道特征、模型和测量的详细讨论请参见[Anderson 1995; Almers 2007]。

上述讨论表明，无线链路中的比特差错将比有线链路中更为常见。因此，无线链路协议（如我们将在下面一节中讨论的 802.11 协议）不仅采用有效的 CRC 错误检测码，还采用了链路层 ARQ 协议来重传受损的帧。

考虑了在无线信道上可能出现的损伤后，我们将注意力转向接收无线信号的主机。该主机接收到一个电磁信号，而该信号是发送方传输的初始信号的退化形式和环境中的背景噪声的结合，其中的信号退化是由于衰减和我们前面讨论过的多路径传播以及其他一些因素所引起的。**信噪比(Signal-to-Noise Ratio, SNR)** 是所收到的信号（如被传输的信息）和噪声强度的相对测量。SNR 的度量单位通常是分贝（dB），有人认为这个主要由电气工程师所使用的度量单位会使计算机科学家迷惑不解。以 dB 度量的 SNR 是下列比值的 20 倍，即接收到的信号的振幅与噪声的振幅的以 10 为底的对数的比值。就我 们的讨论目的而言，我们仅需要知道较大的 SNR 使接收方更容易从背景噪声中提取传输的信号。

图 7-3（该图选自［Holland 2001］）显示了三种不同的调制技术的 **比特差错率(BER)**（大致说来，BER 是在接收方收到的有错传输比特的概率）与 SNR 之比，这些调制技术用于 对信息进行编码以在理想信道上传输。调制和 编码理论以及信号提取和 BER 都超出了本书的范围（对这些主题的讨论参见［Schwar 1980］）。尽管如此，图 7-3 显示了几种物理层的特征，这些特征对于理解较高层无线通信协议是重要的:

![7-3-BER-传输速率-SNR](illustrations/7-3-BER-传输速率-SNR.png)

- 对于给定的调制方案，SNR 越高，BER 越低。由于发送方通过增加它的传输功率就能够增加 SNR，因此发送方能够通过增加它的传输功率来降低接收到差错帧的概率。然而，注意到当该功率超过某个阈值时，如 BER 从 10^-12 降低到 10^-13，可证明几乎不会有实际增益。增加传输功率也会伴随着一些缺点：发送方必须消耗更多的能量（对于用电池供电的移动用户，这一点非常重要），并且发送方的传输更可能干扰另一个发送方的传输（参见图 7-4b）。
- 对于给定的 SNR，图 7-4 隐藏终端问题和衰减具有较高比特传输率的调制技术（无论差错与否）将具有较高的 BER。例如在图 7-3 中，对于 10dB 的 SNR,具有 1Mbps 传输速率的 BPSK 调制具有小于 10^-7 的 BER，而具有 4Mbps 传输速率的 QAM 16 调制，BER 是 10^-1，该值太高而没有实际用处。然而，具有 20dB 的 SNR, QAM 16 调制具有 4Mbps 的传输速率和 10^-7 的 BER，而 BPSK 调制具有仅 1Mbps 的传输速率和一个低得“无法在图上表示”的 BER。如果人们能够容忍 10^-7 的 BER，在这种情况下由 QAM 16 提供的较高的传输速率将使它成为首选的调制技术。这些考虑引出了我们下面描述的最后一个特征。
- 物理层调制技术的动态选择能用于适配对信道条件的调制技术。SNR （因此 BER）可能因移动性或由于环境中的改变而变化。在蜂窝数据系统中以及在 802.11 WiFi，4G，5G 蜂窝数据网络中（我们将在 7-3 节和 7-4 节中学习）使用了自适应调制和编码。例如，这使得对于给定的信道特征选择一种调制技术，在受制于 BER 约束的前提下提供最高的可能传输速率。

![7-4-隐藏终端问题和衰减](illustrations/7-4-隐藏终端问题和衰减.png)

有线和无线链路之间的差异并非仅仅只有较高的、时变的误比特率这一项。前面讲 过在有线广播链路中所有节点能够接收到所有其他节点的传输。而在无线链路中，情况 并非如此简单。如图 7-4 所示，假设站点 A 正在向站点 B 发送，同时假定站点 C 也在向站点 B 传输。由于所谓的 **隐藏终端问题(hidden terminal problem)**，即使 A 和 C 的传输确实是在目的地 B 发生干扰，环境的物理阻挡（例如，一座大山或者一座建筑）也可能会妨碍 A 和 C 互相听到对方的传输。这种情况如图 7-4a 所示。第二种导致在接收方无法检测的碰撞情况是，当通过无线媒体传播时信号强度的 **衰减(fading)**。图 7-4b 图 示了这种情况，A 和 C 所处的位置使得它们的信号强度不足以使它们相互检测到对方的传输，然而它们的传输足以强到在站点 B 处相互干扰。正如我们将在 7-3 节看到的那样，隐藏终端问题和衰减使得多路访问在无线网络中的复杂性远高于在有线网络中的情况。

### 7.2.1. 码分多址(CDMA)

在第 6 章讲过，当不同主机使用一个共享媒体通信时，需要有一个协议来保证多个发送方发送的信号不在接收方互相干扰。在第 6 章中，我们描述了 3 类媒体访问协议：信道划分、随机访问和轮流。**码分多址(Code Division Multiple Access, CDMA)** 属于信道划分 协议族。它在无线 LAN 和蜂窝技术中应用很广泛。由于 CDMA 对无线领域十分重要，在后面小节中对具体的无线接入技术进行探讨以前，我们首先对其快速地浏览一下。

在 CDMA 协议中，要发送的每个比特都通过乘以一个信号(编码)的比特来进行编码，这个信号的变化速率(通常称为 **码片速率**，chipping rate)比初始数据比特序列的变化速率快得多。图 7-5 表示一个简单的、理想化的 CDMA 编码/解码情形。假设初始数据比特到达 CDMA 编码器的速率定义了时间单元；也就是说，每个要发送的初始数据比特需要 1 比特时隙时间。设第 $d_i$ 为第 i 个比特时隙中的数据比特值。为了数学上便利，我们把具有 0 值的数据比特表示为-1。每个比特时隙又进一步细分为 M 个微时隙；在图 7-5 中，M = 8，不过在实际中 M 的值要大得多。发送方使用的 CDMA 编码由 M 个值的一个序列 c(m) 组成，m = 1, ..., M, 每个取值为+1 或者-1。在图 7-5 的例子中，被发送方使用的 M 比特的 CDMA 码是 (1, 1, 1, -1, 1, -1, -1, -1)。

![7-5-一个简单的CDMA例子：发送方编码，接收方解码](illustrations/7-5-一个简单的CDMA例子：发送方编码，接收方解码.png)

为了说明 CDMA 的工作原理，我们关注第 i 个数据比特 $d_i$。对于 $d_i$ 比特传输时间的第 m 个微时隙，CDMA 编码器的输出 $Z_{i,m}$ 是 $d_i$ 乘以分配的 CDMA 编码的第 m 比特 $c_m$：

$$Z_{i,m} = {d_i \cdot c_m} \tag{7-1式}$$

简单地说，对没有干扰的发送方，接收方将收到编码的比特 $Z_{i,m}$，并且恢复初始的数据比特 $d_i$，计算如下：

$$d_i = {{1 \over M} {\displaystyle \sum_{m=1}^{M} Z_{i,m}} \cdot c_m} \tag{7-2式}$$

读者可能想通过推敲图 7-5 所示例子的细节，来明白使用(7-2 式)在接收方确实正确恢复了初始数据比特。

然而，这个世界远不是理想化的，如上面所述，CDMA 必须在存在干扰发送方的情况下工作，这些发送方用分配的不同编码来编码和传输它们的数据。但是当一个发送方的数据比特和其他发送方发送的比特混在一起时，一个 CDMA 接收方怎样恢复该发送方的初始数据比特呢？ CDMA 的工作有一种假设，即对干扰的传输比特信号是加性的，这意味着, 例如在同一个微时隙中，如果 3 个发送端都发送 1，第 4 个发送端发送 -1，那么在那个微时隙中所有的接收方接收的信号都是 2 (因为 1+1+1-1 = 2)。在存在多个发送方时，发送方 s 计算它编码后的传输 $Z_{i,m}^s$ ，计算方式与上面式子中的第一个完全相同。然而在第 i 个比特时隙的第 m 个微时隙期间，接收方现在收到的值是在那个微时隙中从所有 N 个发送方传输的比特的总和：

$$Z_{i,m}^* = {\displaystyle \sum_{s=1}^{N} Z_{i,m}^s}$$

令人吃惊的是，如果仔细地选择发送方的编码，每个接收方只通过(7-2 式)中的同样的方式使用发送方的编码，就能够从聚合的信号中恢复一个给定的发送方发送的数据：

$$d_i = {{1 \over M} {\displaystyle \sum_{m=1}^M {Z_{i,m}^*} \cdot c_m}} \tag{7-3式}$$

如在图 7-6 中所示，描述了两个发送方的 CDMA 例子。上部的发送方使用的 M 比特 CDMA 编码是(1, 1, 1, -1, 1, -1, -1, -1)，而下部的发送方使用的 CDMA 编码是(1, -1, 1, 1, 1, -1, 1, 1)。图 7-6 描述了一个接收方恢复从上部发送方发送的初始数据比特的情况。注意到这个接收方能够提取来自发送方 1 的数据，而不管来自发送方 2 的干扰传输。

再回到我们第 6 章中鸡尾酒会的类比，一个 CDMA 协议类似于让聚会客人使用多种语言来谈论；在这种情况下，人们实际上非常善于锁定他们能听懂的语言的谈话，而过滤了其余的谈话。我们这里看到 CDMA 是一个划分协议，因为它划分编码空间(与时间或频率相对)，并且给每个节点分配一段专用的代码空间。

我们这里对 CDMA 的讨论是简要的；实践中还必须处理大量的困难问题。首先，为了使 CDMA 接收方能够提取一个特定的发送方的信号，必须仔细地选择 CDMA 编码。其次，我们的讨论假设在接收方接收到的来自从不同发送方的信号强度是相同的；这可能在实际中很难获得。有大量的文章讨论了有关 CDMA 的这些和其他问题；详细内容见[Pickholtz 1982； Viterbi 1995] 。

![7-6-两个发送方的CDMA例子](illustrations/7-6-两个发送方的CDMA例子.png)

**time : 2021-07-07**

## 7.3. 无线局域网

当前，无线 LAN 在工作场所、家庭、教育机构、咖啡屋、机场以及街头无所不在, 它已经成为因特网中的一种十分重要的接入网技术。尽管在 20 世纪 90 年代研发了许多有关无线 LAN 的标准和技术，但其中有一类标准已经明显成为赢家：**IEEE 802.11 无线 LAN** (也称为 **WiFi**)。在本节中，我们将详细研究 802.11 无线 LAN，分析它的帧结构、它的媒体访问协议以及 802.11 LAN 与有线以太网 LAN 的互联。

在 IEEE 802.11 协议族中有几套有关无线 LAN 的 802.11 标准[IEEE 802.11 2020]，下表对它们进行了总结。802.11 b，g，n，ac，ax 是 802.11 无线局域网技术的紧接着的一代，他们的工作范围通常小于 70m，常常用于家庭办公，工作区和商业环境。802.11 n，ac 和 ax 标准最近分别被打上了 WiFi 4、5 和 6 的牌子：无疑是在与 4G 和 5G 蜂窝网络的品牌竞争。802.11af，ah 标准在更远的距离上运行，主要针对物联网、传感器网络和计量系统。标准可以在更远的距离上运行，主要针对物联网、传感器网络和计量应用。

不同的 802.11 b，g，n，ac，ax 标准都有一些共同特点。包括我们不久将研究的 802.11 帧格式，并且向后兼容。兼容，这意味着，例如，一个只能够使用 802.11 g 的移动设备仍然可以与较新的 802.11 ac 或 802.11 ax 基站互动。它们也都使用相同的媒体访问协议，即 CSMA/CA，我们很快就会讨论这个问题。同时 802.11 ax 也支持基站对相关无线设备的传输进行集中调度。而 802.11 ax 也支持基站集中调度来自相关无线设备的传输。

然而，如下表所示，这些标准在物理层有一些主要的区别。802.11 设备工作在两个不同的频率范围：2.4-2.485 GHz（称为 2.4 GHz 范围）和 5.1-5.8 GHz（称为 5 GHz 范围）。2.4GHz 范围是一个未经许可的频段，802.11 设备可能与 2.4GHz 电话和微波炉等设备竞争频谱。在 5GHz，802.11 局域网在给定的功率水平下有较短的传输距离，并受到更多的多径传播的影响。802.11n、802.11ac 和 802.11ax 标准使用多输入多输出（MIMO）天线；也就是说，发送端有两根或多根天线，接收端有两根或多根天线在发送/接收不同的信号[Diggavi 2004]。802.11ac 和 802.11 ax 基站可以同时向多个站点发送信号，并使用 "智能 "天线自适应波束格式，以接收器的方向为目标进行传输。这减少了干扰，并增加了在给定数据率下达到的距离。下表中显示的数据速率是在一个理想化的环境中，例如，接收器靠近基站，没有干扰：这是我们在实践中不太可能遇到的情况。因此，正如俗话所说，YMMV：你的里程（或在这种情况下你的无线数据速率）可能会有所不同。

| IEEE 802.11 标准   | 年份            | 最高传输速率 | 范围 | 频率                         |
| ------------------ | --------------- | ------------ | ---- | ---------------------------- |
| 802.11 b           | 1999            | 11 Mbps      | 30 m | 2.4 Ghz                      |
| 802.11 g           | 2003            | 54 Mbps      | 30 m | 2.4 Ghz                      |
| 802.11 n (WiFi 4)  | 2009            | 600 Mbps     | 70 m | 2.4, 5 Ghz                   |
| 802.11 ac (WiFi 5) | 2013            | 3.47 Gpbs    | 70 m | 5 Ghz                        |
| 802.11 ax (WiFi 6) | 2020 (expected) | 14 Gbps      | 70 m | 2.4, 5 Ghz                   |
| 802.11 af          | 2014            | 35–560 Mbps  | 1 Km | unused TV bands (54–790 MHz) |
| 802.11 ah          | 2017            | 347 Mbps     | 1 Km | 900 Mhz                      |

### 7.3.1. 802.11 架构

图 7-7 显示了 802. 11 无线 LAN 体系结构的基本构件。802.11 体系结构的基本构件模块是 **基本服务集(Basic Service Set, BSS)**。一个 BSS 包含一个或多个无线站点和一个在 802.11 术语中称为 **接入点(Access Point, AP)** 的 **中央基站(base station)** 。图 7-7 展示了两个 BSS 中的 AP，它们连接到一个互联设备上（如交换机或者路由器），互联设备又连接到因特网中。在一个典型的家庭网络中，有一个 AP 和一台将该 BSS 连接到因特网中的路由器（通常综合成为一个单元）。

与以太网设备类似，每个 802.11 无线站点都具有一个 6 字节的 MAC 地址，该地址存储在该站适配器（即 802.11 网络接口卡）的固件中。每个 AP 的无线接口也具有一个 MAC 地址。与以太网类似，这些 MAC 地址由 IEEE 管理，理论上是全球唯一的。

如 7-1 节所述，配置 AP 的无线 LAN 经常被称作 **基础设施无线 LAN(infrastructure wireless LAN)**，其中的“基础设施”是指 AP 连同互联 AP 和一台路由器的有线以太网。图 7-8 显示了 IEEE 802.11 站点也能将它们自己组合在一起形成一个自组织网络，即一个无中心控制和与“外部世界”无连接的网络。这里，该网络是由彼此已经发现相互接近且 有通信需求的移动设备“动态”形成，并且在它们所处环境中没有预先存在的网络基础设施。当携带便携机的人们聚集在一起时（例如，在一个会议室、一列火车或者一辆汽车中），并且要在没有中央化的 AP 的情况下交换数据，一个自组织网络就可能形成了。随着要通信的便携设备的继续激增，人们对自组织网络产生巨大的兴趣。然而在本节中，我们只关注基础设施无线 LAN。

![7-7-IEEE-802.11架构](illustrations/7-7-IEEE-802.11架构.png)

![7-8-IEEE-802.11自组织网络](illustrations/7-8-IEEE-802.11自组织网络.png)

**信道与关联**

在 802.11 中，每个无线站点在能够发送或者接收网络层数据之前，必须与一个 AP 相关联。尽管所有 802.11 标准都使用了关联，但我们将专门在 IEEE 802.11 b/g 环境中讨论这一主题。

当网络管理员安装一个 AP 时，管理员为该接入点分配一个单字或双字的 **服务集标识符(Service Set Identifier, SSID)**。(例如，当你在 iPhone 上选择设置 WiFi 时，将显示某范围内每个 AP 的 SSID)管理员还必须为该 AP 分配一个信道号。为了理解信道号，回想前面讲过的 802.11 运行在 2.4-2.4835GHz 的频段中。在这个 85MHz 的频段内，802. 11 定义了 11 个部分重叠的信道。当且仅当两个信道由 4 个或更多信道隔开时它们才无重叠。特别是信道 1、6 和 11 的集合是唯一的 3 个非重叠信道的集合。这意味着管理员可以在同一个物理网络中安装 3 个 802.lib AP,为这些 AP 分配信道 1、6 和 11，然后将每个 AP 都连接到一台交换机上。

既然已经对 802. 11 信道有了基本了解，我们则可以描述一个有趣(且并非完全不寻常)的情况，即有关 WiFi 丛林。**WiFi 丛林(WiFi jungle)** 是一个任意物理位置，在这里无线站点能从两个或多个 AP 中收到很强的信号。例如，在纽约城的许多咖啡馆中，无线站点可以从附近许多 AP 中选取一个信号。其中一个 AP 可能由该咖啡馆管理，而其他 AP 可能位于咖啡馆附近的住宅区内。这些 AP 中的每一个都可能位于不同的子网中，并被独立分配一个信道。

现在假定你带着自己的手机、平板电脑或便携机进入这样一个 WiFi 丛林，寻求无线因特网接入和一个蓝莓松饼。设在这个丛林中有 5 个 AP。为了获得因特网接入，你的无线站点需要加入其中一个子网并因此需要与其中的一个 AP 相 **关联(associate)**。关联意味着这一无线站点在自身和该 AP 之间创建一个虚拟线路。特别是，仅有关联的 AP 才向你 的无线站点发送数据帧，并且你的无线站点也仅仅通过该关联 AP 向因特网发送数据帧。然而，你的无线站点是如何与某个特定的 AP 相关联的？更为根本的问题是，你的无线站点是如何知道哪个 AP 位于该丛林呢？

802.11 标准要求每个 AP 周期性地发送 **信标帧(beacon frame)**，每个信标帧包括该 AP 的 SSID 和 MAC 地址。你的无线站点为了得知正在发送信标帧的 AP,扫描 11 个信道，找出来自可能位于该区域的 AP 所发出的信标帧(其中一些 AP 可能在相同的信道中传输, 即这里有一个丛林！)。通过信标帧了解到可用 AP 后，你(或者你的无线主机)选择一个 AP 用于关联。

802.11 标准没有指定选择哪个可用的 AP 进行关联的算法；该算法被遗留给 802.11 固件和无线主机的软件设计者。通常，主机选择接收到的具有最高信号强度的信标帧。虽然高信号强度好（例如可参见图 7-3）,信号强度将不是唯一决定主机接收性能的 AP 特性。特别是，所选择的 AP 可能具有强信号，但可能被其他附属的主机（将需要共享该 AP 的无线带宽）所过载，而某未过载的 AP 由于稍弱的信号而未被选择。选择 AP 的一些可替代的方法近来已被提出[Vasudevan 2005 ； Nicholson 2006； Sudaresan 2006 ]。有关信号强度如何测量的有趣而朴实的讨论参见[Bardwell 2004]。

扫描信道和监听信标帧的过程被称为 **被动扫描(passive scanning)**（参见图 7-9a）。无线主机也能够执行 **主动扫描(active scanning)**，这是通过向位于无线主机范围内的所有 AP 广播探测帧完成的，如图 7-9b 所示。AP 用一个探测响应帧应答探测请求帧。无线主机则能够在响应的 AP 中选择某 AP 与之相关联。

![7-9-主动扫描和动扫描](illustrations/7-9-主动扫描和动扫描.png)

选定与之关联的 AP 后，无线主机向 AP 发送一个关联请求帧，并且该 AP 以一个关联响应帧进行响应。注意到对于主动扫描需要这种第二次请求/响应握手，因为一个对初始探测请求帧进行响应的 AP 并不知道主机选择哪个（可能多个）响应的 AP 进行关联，这与 DHCP 客户能够从多个 DHCP 服务器进行选择有诸多相同之处（参见图 4-24）。一旦与 一个 AP 关联，该主机希望加入该 AP 所属的子网中（以 4-3-3 节中的 IP 寻址的意义）。 因此。该主机通常将通过关联的 AP 向该子网发送一个 DHCP 发现报文（参见图 4-24），以获取在该 AP 子网中的一个 IP 地址。一旦获得地址，网络的其他部分将直接视你的主机 为该子网中的另一台主机。

为了与特定的 AP 创建一个关联，某无线站点可能要向该 AP 鉴别它自身。802.11 无线 LAN 提供了几种不同的鉴别和接入方法。一种被许多公司采用的方法是，基于一 个站点的 MAC 地址允许其接入一个无线网络。第二种被许多因特网咖啡屋采用的方法 是，应用用户名和口令。在两种情况下，AP 通常与一个鉴别服务器进行通信，使用一 种诸如 RADIUS [RFC 2865]或 DIAMETER [RFC 6733]的协议，在无线终端站和鉴别 服务器之间中继信息。分离鉴别服务器和 AP，使得一个鉴别服务器可以服务于多个 AP，将（经常是敏感的）鉴别和接入的决定集中到单一服务器中，使 AP 费用和复杂性较低。我们将在第 8 章看到，定义 802.11 协议族安全性的新 IEEE 802.11 i 协议就恰好采用了这一方法。

### 7.3.2. 802.11 MAC 协议

一旦某无线站点与一个 AP 相关联，它就可以经该接入点开始发送和接收数据帧。然而因为许多无线设备或 AP 自身可能希望同时经过相同信道传输数据帧，因此需要一 个多路访问协议来协调传输。下面，我们将无线设备或 AP 称为 **站点(station)**，它们共享多个接入信道。正如在第 6 章和 7-2-1 节中讨论的那样，宽泛地讲有三类多路访问协 议：信道划分（包括 CDMA）、随机访问和轮流。受以太网及其随机访问协议巨大成功的激励，802.11 的设计者为 802.11 无线 LAN 选择了一种随机访问协议。这个随机访问协议称作 **带碰撞避免的 CSMA(CSMA with collision avoidance)**，或简称为 CSMA/CA。与以太网的 CSMA/CD 相似，CSMA/CA 中的“CSMA”代表“载波侦听多路访问”，意味着每个站点在传输之前侦听信道，并且一旦侦听到该信道忙则抑制传输。尽管以太网和 802. 11 都使用载波侦听随机接入，但这两种 MAC 协议有重要的区别。首先，802.11 使用碰撞避免而非碰撞检测。其次，由于无线信道相对较高的误比特率，802.11（不同于以太网）使用链路层确认/重传（ARQ）方案。我们将在下面讨论 802.11 的碰撞避免和链路层确认机制。

在 6-3-2 节和 6-4-2 节曾讲过，使用以太网的碰撞检测算法，以太网节点在发送过程 中监听信道。在发送过程中如果检测到另一节点也在发送，则放弃自己的发送，并且在等 待一个小的随机时间后再次发送。与 802.3 以太网协议不同，802.11 MAC 协议并未实现碰撞检测。这主要由两个重要的原因所致:

- 检测碰撞的能力要求站点具有同时发送（站点自己的信号）和接收（检测其他站 点是否也在发送）的能力。因为在 802.11 适配器上，接收信号的强度通常远远小于发送信号的强度，制造具有检测碰撞能力的硬件代价较大。
- 更重要的是，即使适配器可以同时发送和监听信号（并且假设它一旦侦听到信道 忙就放弃发送），适配器也会由于隐藏终端问题和衰减问题而无法检测到所有的碰撞，参见 7-2 节的讨论。

由于 802.11 无线局域网不使用碰撞检测，一旦站点开始发送一个帧，它就完全地发送该帧；也就是说，一旦站点开始发送，就不会返回。正如人们可能猜想的那样，碰撞存在时仍发送整个数据帧（尤其是长数据帧）将严重降低多路访问协议的性能。为了降低碰撞的可能性，802.11 采用几种碰撞避免技术，我们稍后讨论它们。

然而，在考虑碰撞避免之前，我们首先需要分析 802.11 的 **链路层确认(link-layer acknowledgment)** 方案。7-2 节讲过，当无线 LAN 中某站点发送一个帧时，该帧会由于多种原因不能无损地到达目的站点。为了处理这种不可忽视的故障情况，802.11 MAC 使用链路层确认。如图 7-10 所示，目的站点收到一个通过 CRC 校验的帧后，它等待一个被称作 **短帧间间隔(Short Inter-Frame Spacing, SIFS)** 的一小段时间，然后发回一个确认帧。 如果发送站点在给定的时间内未收到确认帧，它假定出现了错误并重传该帧，使用 CS-MA/CA 协议访问该信道。如果在若干固定次重传后仍未收到确认，发送站点将放弃发送并丢弃该帧。

![7-10-802.11使用链路层确认](illustrations/7-10-802.11使用链路层确认.png)

讨论过 802.11 如何使用链路层确认后，我们可以描述 802.11 的 CSMA/CA 协议了。 假设一个站点（无线站点或者 AP）有一个帧要发送。

(1) 如果某站点最初监听到信道空闲，它将在一个被称作 **分布式帧间间隔(DistributeInter-Frame Space, DIFS)** 的短时间段后发送该帧，
(2) 否则，该站点选取一个随机回退值（如我们在 6-3-2 节中遇到的那样）并且在侦听信道空闲时递减该值。当侦听到信道忙时，计数值保持不变。
(3) 当计数值减为 0 时（注意到这只可能发生在信道被侦听为空闲时），该站点发送整个数据帧并等待确认。
(4) 如果收到确认，发送站点知道它的帧已被目的站正确接收了。如果该站点要发送另一帧，它将从第二步开始 CSMA/CA 协议。如果未收到确认，发送站点将重新进入第二步中的回退阶段，并从一个更大的范围内选取随机值。

前面讲过，在以太网的 CSMA/CD 的多路访问 协议（6-3-2 节）下，一旦侦听到信道空闲，站点开始发送。然而，使用 CSMA/CA，该站点在倒计数时抑制传输，即使它侦听到该信道空闲也是如此。为什么 CSMA/CD 和 CSMA/CA 采用了不同的方法呢？

为了回答这一问题，我们首先考虑这样一种情形：两个站点分别有一个数据帧要发送，但是，由于侦听到第三个站点已经在传输，双方都未立即发送。使用以太网的 CSMA/CD 协议中, 两个站点将会在检测到第三方发送完毕后立即开始发送。这将导致一个碰撞，在 CSMA/CD 协议中碰撞并非是一个严重的问题，因为两个站点检测到碰撞后都会放弃它们的发送, 从而避免了由于碰撞而造成的该帧剩余部分的无用发送。而在 802.11 中情况却十分不同，因为 802.11 并不检测碰撞和放弃发送，遭受碰撞的帧仍将被完全传输。因此 802.11 的目标是无论如何尽可能避免碰撞。在 802.11 中，如果两个站点侦听到信道忙，它们都将立即进入随机回退，希望选择一个不同的回退值。如果这些值的确不同，一旦信道空闲，其中的一个站点将在另一个之前发送，并且（如果两个站点均未对对方隐藏）“失败站点”将会听到“胜利站点”的信号，冻结它的计数器，并在胜利站点完成传输之前一直抑制传输。通过这种方式，避免了髙代价的碰撞。当然，在以下情况下使用 802.11 仍可能出现碰撞：两个站点可能互相是隐藏的，或者两者可能选择了非常靠近的随机回退值，使来自先开始站点的传输也必须到达第二个站点。回想前面我们在图 6-12 的环境中讨论随机访问算法时遇到过这个问题。

1. **处理隐藏终端：RTS 和 CTS**

   802.11 MAC 协议也包括了一个极好（但为可选项）的预约方案，以帮助在出现隐藏终端的情况下避免碰撞。我们在图 7-11 的环境下研究这种方案，其中显示了两个无线站点和一个接入点。

这两个无线站点都在该 AP 的覆盖范围内(其覆盖范围显示为阴影圆环)，并且两者都与该 AP 相关联。然而，由于衰减，无线节点的信号范围局限在图 7-11 所示的阴影圆环内部。因此，尽管每个无线站点对 AP 都不隐藏，两者彼此却是隐藏的。

![7-11-隐藏终端的例子：H1和H2%20彼此互相隐藏](illustrations/7-11-隐藏终端的例子：H1和H2%20彼此互相隐藏.png)

现在我们考虑为什么隐藏终端会导致出现问题。假设站点 H1 正在传输一个帧，并且在 H1 传输的中途，站点 H2 要向 AP 发送一个帧。由于 H2 未听到来自 H1 的传输，它将首先等待一个 DIFS 间隔，然后发送该帧，导致产生了一个碰撞。从而在 H1 和 H2 的整个发送阶段，信道都被浪费了。

为了避免这一问题，IEEE 802.11 协议允许站点使用一个 **短请求发送(Request to Send, RTS)** 控制帧和一个 **短允许发送(Clear to Send, CTS)** 控制帧来预约对信道的访问。当发送方要发送一个 data 帧时，它能够首先向 AP 发送一个 RTS 帧，指示传输 DATA 帧和确认(ACK)帧需要 的总时间。当 AP 收到 RTS 帧后，它广播一个 CTS 帧作为响应。该 CTS 帧有两个目的：给发送方明确的发送许可，也指示其他站点在预约期内不要发送。

因此，在图 7-12 中，在传输 DATA 帧前，H1 首先广播一个 RTS 帧，该帧能被 其范围内包括 AP 在内的所有站点听到。 AP 然后用一个 CTS 帧响应，该帧也被其范围内包括 H1 和 H2 在内的所有站点听到。站点 H2 听到 CTS 后，在 CTS 帧中指明的时间内将抑制发送。RTS、CTS、 DATA 和 ACK 帧如图 7-12 所示。RTS 和 CTS 帧的使用能够在两个重要方面提高性能：

![7-12-使用RTS和CTS帧的碰撞避免](illustrations/7-12-使用RTS和CTS帧的碰撞避免.png)

- 隐藏终端问题被缓解了，因为长 DATA 帧只有在信道预约后才被传输。
- 因为 RTS 和 CTS 帧较短，涉及 RTS 和 CTS 帧的碰撞将仅持续短 RTS 和 CTS 帧的持续期。一旦 RTS 和 CTS 帧被正确传输，后续的 DATA 和 ACK 帧应当能无碰撞地发送。

尽管 RTS/CTS 交换有助于降低碰撞，但它同样引入了时延以及消耗了信道资源。因此，RTS/CTS 交换仅仅用于为长数据帧预约信道。在实际中，每个无线站点可以设置一个 RTS 门限值，仅当帧长超过门限值时，才使用 RTS/CTS 序列。对许多无线站点而言，默认的 RTS 门限值大于最大帧长值，因此对所有发送的 DATA 帧，RTS/CTS 序列都被跳过。

2. **使用 802.11 作为一个点对点链路**

到目前为止我们的讨论关注在多路访问环境中使用 802.11。应该指出，如果两个节点每个都具有一个定向天线，它们可以将其定向天线指向对方，并基本上是在一个点对点的 链路上运行 802.11 协议。如果商用 802.11 硬件产品价格低廉，那么使用定向天线以及增 加传输功率使得 802.11 成为一个在数十公里距离中提供无线点对点连接的廉价手段。 [Raman 2007]描述了这样一个运行于印度恒河郊区平原上的多跳无线网络，其中包含了 点对点 802.11 链路。

### 7.3.3. IEEE 802.11 帧

尽管 802.11 帧与以太网帧有许多共同特点，但它也包括了许多特定用于无线链路的 字段。802.11 帧如图 7-13 所示，在该帧上的每个字段上面的数字代表该字段以字节计的长度；在该帧控制字段中，每个子字段上面的数字代表该子字段以比特计的长度。现在我们查看该帧中各字段以及帧控制字段中一些重要的子字段。

![7-13-802.11帧](illustrations/7-13-802.11帧.png)

1. **有效载荷与 CRC 字段**

帧的核心是有效载荷，它通常是由一个 IP 数据报或者 ARP 分组组成。尽管这一字段允许的最大长度为 2312 字节，但它通常小于 1500 字节，放置一个 IP 数据报或一个 ARP 分组。如同以太网帧一样，802.11 帧包括一个循环冗余校验（CRC）,从而接收方可以检 测所收到帧中的比特错误。如我们所看到的那样，比特错误在无线局域网中比在有线局域网中更加普遍，因此 CRC 在这里更加有用。

2. **地址字段**

也许 802.11 帧中最引人注意的不同之处是它具有 4 个地址字段，其中每个都可以包含一个 6 字节的 MAC 地址。但为什么要 4 个地址字段呢？如以太网中那样，一个源 MAC 地址字段和一个目的 MAC 地址字段不就足够了？事实表明，出于互联目的需要 3 个地址字段，特别是将网络层数据报从一个无线站点通过一个 AP 送到一台路由器接口。当 AP 在自组织模式中互相转发时使用第四个地址。由于我们这里仅仅考虑基础设施网络，所以只关注前 3 个地址字段。802.11 标准定义这些字段如下：

- 地址 2 是传输该帧的站点的 MAC 地址。因此，如果一个无线站点传输该帧，该站 点的 MAC 地址就被插入在地址 2 字段中。类似地，如果一个 AP 传输该帧，该 AP 的 MAC 地址也被插入在地址 2 字段中。
- 地址 1 是要接收该帧的无线站点的 MAC 地址。因此，如果一个移动无线站点传输 该帧，地址 1 包含了该目的 AP 的 MAC 地址。类似地，如果一个 AP 传输该帧, 地址 1 包含该目的无线站点的 MAC 地址。
- 为了理解地址 3，回想 BSS （由 AP 和无线站点组成）是个子网的一部分，并且这个子网经一些路由器接口与其他子网相连。地址 3 包含这个路由器接口的 MAC 地址。

为了对地址 3 的目的有更深入的理解，我们观察在图 7-14 环境中的网络互联的例子。在这幅图中，有两个 AP，每个 AP 负责一些无线站点。每个 AP 到路由器有一个直接连接，路由器依次又连接到全球因 特网。我们应当记住 AP 是链路层设备，它既不能“说” IP 又不理解 IP 地址。现在考虑将一个数据报从路由器接口 R1 移到无线站点 H1。路由器并不清楚在它和 H1 之间有一个 AP；从路由器的观点来说，H1 仅仅是路由器所连接的子网中的一台主机。

![7-14-在802.11帧中使用地址字段](illustrations/7-14-在802.11帧中使用地址字段.png)

- 路由器知道 H1 的 IP 地址（从数据报的目的地址中得到），它使用 ARP 来确定 H1 的 MAC 地址，这与在普通的以太网 LAN 中相同。获取 H1 的 MAC 地址后，路由器接口 R1 将该数据报封装在一 个以太网帧中。该帧的源地址字段包含了 R1 的 MAC 地址，目的地址字段包含 H1 的 MAC 地址。
- 当该以太网帧到达 AP 后，该 AP 在将其传输到无线信道前，先将该 802.3 以太网 帧转换为一个 802.11 帧。如前所述，AP 将地址 1 和地址 2 分别填上 H1 的 MAC 地址和其自身的 MAC 地址。对于地址 3，AP 插入 R1 的 MAC 地址。通过这种方式，H1 可以确定（从地址 3）将数据报发送到子网中的路由器接口的 MAC 地址。

现在考虑在从 H1 移动一个数据报到 R1 的过程中无线站点 H1 进行响应时发生的情况。

- H1 生成一个 802.11 帧，如上所述，分别用 AP 的 MAC 地址和 H1 的 MAC 地址填 充地址 1 和地址 2 字段。对于地址 3，H1 插入 R1 的 MAC 地址。
- 当 AP 接收该 802.11 帧后，将其转换为以太网帧。该帧的源地址字段是 H1 的 MAC 地址，目的地址字段是 R1 的 MAC 地址。因此，地址 3 允许 AP 在构建以太网帧时能够确定目的 MAC 地址。

总之，地址 3 在 BSS 和有线局域网互联中起着关键作用。

3. **序号、持续期和帧控制字段**

前面讲过在 802.11 网络中，无论何时一个站点正确地收到一个来自于其他站点的帧, 它就回发一个确认。因为确认可能会丢失，发送站点可能会发送一个给定帧的多个副本。 正如我们在 rdt 2.1 协议讨论中所见（3-4-1 节），使用序号可以使接收方区分新传输的帧和以前帧的重传。因此在 802.11 帧中的序号字段在链路层与在第 3 章中运输层中的该字段有着完全相同的目的。

前面讲过 802.11 协议允许传输节点预约信道一段时间，包括传输其数据帧的时间和传输确认的时间。这个持续期值被包括在该帧的持续期字段中（在数据帧和 RTS 及 CTS 帧中均存在）。

如图 7-13 所示，帧控制字段包括许多子字段，我们将提一下其中比较重要的子字段，更加完整的讨论请参见 802.11 规范［Held 2001 ； Crow 1997； IEEE 802.11 1999］。类型和子类型字段用于区分关联、RTS、CTS、ACK 和数据帧。To（到）和 From（从）字段用于定义不同地址字段的含义。（这些含义随着使用自组织模式或者基础设施模式而改变，而且在使用基础设施模式时，也随着是无线站点还是 AP 在发送帧而变化。）最后，WEP 字段指示了是否使用加密（WEP 将在第 8 章中讨论。）

### 7.3.4. 在相同的 IP 子网中的移动性

为了增加无线 LAN 的物理范围，公司或大学经常会在同一个 IP 子网中部署多个 BSS。这自然就引出了在多个 BSS 之间的移动性问题，即无线站点如何在维持进行中的 TCP 会话的情况下，无缝地从一个 BSS 移动到另一个 BSS？正如我们将在本小节中所见，当这些 BSS 属于同一子网时，移动性可以用一种相对直接的方式解决。当站点在不同子网间移动时，就需要更为复杂的移动性管理协议了，我们将在 7-5 节和 7-6 节中学习这些协议。

我们现在看一个同一子网中的不同 BSS 之间的移动性的特定例子。图 7-15 显示了具有一台主机 H1 的两个互联的 BSS,该主机从 BSS1 移动到 BSS2O 因为在这个例子中连接两个 BSS 的互联设备不是一台路由器，故在两个 BSS 中的所有站点（包括 AP）都属于同一个 IP 子网。因此，当 H1 从 BSS1 移动到 BSS2 时，它 可以保持自己的 IP 地址和所有正在进行的 TCP 连接。如果互联设备是一台路由器，则 H1 必须在它移动进入的子网中获得一个新地址。这种地址的变化将打断（并且最终终止）在 H1 的任何 进行中的 TCP 连接。在 7-6 节中，我们将能看到 一种网络层移动性协议如移动 IP 能被用于避免该问题。

![7-15-相同子网中的移动性](illustrations/7-15-相同子网中的移动性.png)

但是 H1 从 BSS1 移动到 BSS2 时具体会发生哪些事呢？随着 H1 逐步远离 AP1，H1 检测到来自 AP1 的信号逐渐减弱并开始扫描一个更强的信号。H1 收到来自 AP2 的信标帧（在许多公司和大学的设置中它与 API 有相同的 SSID）。H1 然后与 AP1 解除关联，并与 AP2 关联起来，同时保持其 IP 地址和维持正在进行的 TCP 会话。

从主机和 AP 的角度，这就处理了切换问题。但对图 7-15 中的交换机又会发生什么样 的情况呢？交换机如何知道主机已经从一个 AP 移动到另一个 AP 呢？回想第 6 章所述，交换机是“自学习”的，并且自动构建它们的转发表。这种自学习的特征很好地处理了偶尔的移动（例如，一个雇员从一个部门调转到另一个部门）。然而，交换机没有被设计用 来支持用户在不同 BSS 间高度移动，同时又希望保持 TCP 连接。为理解这一问题，回想在移动之前，交换机在其转发表中有一个表项，对应 H1 的 MAC 地址与到达 H1 所通过的出交换机端口。如果 H1 初始在 BSS1 中，则发往 H1 的数据报将经 AP1 导向 H1。然而，一旦 H1 与 BSS2 关联，它的帧应当被导向 AP2O 一种解决方法（真有点不规范）是在新的关联形成后，让 AP2 以 H1 的源地址向交换机发送一以太网广播帧。当交换机收到该帧后，更新其转发表，使得 H1 可以通过 AP2 到达。802.11 f 标准小组正在开发一个 AP 间的协议来处理这些以及相关的问题。

我们以上的讨论关注了在相同 LAN 子网中的移动性。前面我们在 6-4-4 节学习过 VLAN, 它能够用来将若干 LAN 孤岛连接成为一个大虚拟 LAN，该虚拟 LAN 能够跨越很大的地理范围。在这种 VALN 中的基站之间的移动性能够以上述完全相同的方式来处理［Yu 2011］。

### 7.3.5. 802.11 中的高级特色

我们将简要地讨论 802.11 网络中具有的两种高级能力，以此来完成我们学习 802.11 的内容。如我们所见，这些能力并不是完全特定于 802.11 标准的，而是在该标准中可能由特定机制产生的。这使得不同的厂商可使用他们自己（专用）的方法来实现这些能力，这也许能让他们增强竞争能力。

1. **802.11 速率适应**

我们在前面图 7-3 中看到，不同的调制技术（提供了不同的传输速率）适合于不同的 SNR 情况。考虑这样一个例子，一个 802. 11 用户最初离基站 20 米远，这里信噪比高。在此高信噪比的情况下，该用户能够与基站使用可提供高传输速率的物理层调制技术进行通 信，同时维持低 BER。这个用户多么幸福啊！假定该用户开始移动，向离开基站的方向走去，随着与基站距离的增加，SNR 一直在下降。在这种情况下，如果在用户和基站之间运行的 802.11 协议所使用的调制技术没有改变的话，随着 SNR 减小，BER 将高得不可接受，最终，传输的帧将不能正确收到。

由于这个原因，某些 802.11 实现具有一种速率自适应能力，该能力自适应地根据当前和近期信道特点来选择下面的物理层调制技术。如果一个节点连续发送两个帧而没有收- 到确认（信道上一个比特差错的隐式指示），该传输速率降低到前一个较低的速率。如果 10 个帧连续得到确认，或如果用来跟踪自上次降速以来时间的定时器超时，该传输速率 提高到上一个较高的速率。这种速率适应机制与 TCP 的拥塞控制机制具有相同的“探测” 原理，即当条件好时（反映为收到 ACK），增加传输速率，除非某个“坏事”发生了（ACK 没有收到）；当某个“坏事”发生了，减小传输速率。因此，802.11 的速率适应和 TCP 的拥塞控制类似于年幼的孩子，他们不断地向父母要求越来越多（如幼儿要糖果，青少年要求推迟睡觉），直到父母亲最后说“够了！”，孩子们不再要求了（仅当以后情况已 经变好了才会再次尝试）。已经提出了一些其他方案以改善这个基本的自动速率调整方案 ［Kamerman 1997 ； Holland 2001 ； Lac age 2004]。

2. **功率管理**

功率是移动设备的宝贵资源，因此 802.11 标准提供了功率管理能力，以使 802.11 节点的侦听、传输和接收功能以及其他需要“打开”电路的时间量最小化。802.11 功率管理按下列方式运行。一个节点能够明显地在睡眠和唤醒状态之间交替（像在课堂上睡觉的学生！）。通过将 802.11 帧首部的功率管理比特设置为 1，某节点向接入点指示它将打算睡眠。设置节点中的一个定时器，使得正好在 AP 计划发送它的信标帧前唤醒节点（前面讲过 AP 通常每 100ms 发送一个信标帧）。因为 AP 从设置的功率传输比特知道哪个节点打算睡眠，所以该 AP 知道它不应当向这个节点发送任何帧，先缓存目的地为睡眠主机的任何帧，待以后再传输。

在 AP 发送信标帧前，恰好唤醒节点，并迅速进入全面活动状态（与睡觉的学生不同，这种唤醒仅需要 250 微秒［Kamerman 1997］）。由 AP 发送的信标帧包含了帧被缓存在 AP 中的节点的列表。如果某节点没有缓存的帧，它能够返回睡眠状态。否则，该节点能够通过向 AP 发送一个探询报文明确地请求发送缓存的帧。对于信标之间的 100ms 时间来说，250 微秒的唤醒时间以及类似的接收信标帧及检查以确保不存在缓存帧的短小时间，没有帧要发送和接收的节点能够睡眠 99%的时间，从而大大节省了能源。

### 7.3.6. 个人域网络：蓝牙

蓝牙网络似乎已经很快成为日常生活的一部分。也许你曾使用蓝牙网络替代网线来连接你的电脑和一个无线键盘，无线鼠标，或其他外设。也或许，你曾使用蓝牙网络来连接你的无线耳机，扬声器，手表，或者健康监测手环到你的智能手机，或者连接智能手机到汽车的音频系统。在所有这些使用场景中，蓝牙在一个短距离（小于 10m），以低功率运作。由于这个原因，蓝牙网络有时被称为 **无线个人域网络(wireless personal area networks, WPAN)** 或 **piconet**。

尽管蓝牙在设计上是相对简单的，但蓝牙也应用到了我们以前讨论过的很多链路层技术，包括时分复用，频分复用(6-3-1 节)，随机回撤(6-3-2 节)，轮询(6-3-3 节)，错误检测和修正(6-2 节)，通过肯定确认和否定确认的可靠数据传输(3-4-1 节)。而且这只考虑了蓝牙的链路层。

蓝牙网络在无许可证的 2.4GHz 工业、科学和医疗（ISM）无线电频段内运行，和其他家用电器如微波炉、车库门开启器和无绳电话一起。因此，蓝牙网络的设计明确考虑到了噪音和干扰。蓝牙无线通道以 TDM 方式运行，时隙为 625 微秒。在每个时隙中，发送者在 79 个信道中的一个进行传输，信道（频率）以已知但伪随机的方式从一个时隙变化到另一个时隙。这种跳信道的形式，被称为 **跳频扩展频(Frequency-Hopping Spread Spectrum, FHSS)**，是为了让在 ISM 频段工作的另一个设备或电器的干扰只在最多一个子集的时隙中干扰蓝牙通信。蓝牙的数据速率可以达到 3Mbps。

蓝牙网络是自组织网络：不需要网络基础设施（如一个接入点）来互连设备。相反，蓝牙设备将他们组织进一个最多可支持 8 个设备 piconet，如图 7-16 所示。其中一个设备被设计为主设备，其他设备为客户。

![7-16-一个蓝牙网络](illustrations/7-16-一个蓝牙网络.png)
